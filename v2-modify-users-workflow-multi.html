<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiple Subscriptions - Geographic Assignment</title>
<link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.5.1/css/all.css">
<link rel="stylesheet" href="blueprint-workflow-styles.css">
<style>
/* Page-specific overrides for Blueprint Design System */
</style>
</head>
<body>

<!-- Top Bar -->
<div class="top-bar">
  <button class="hamburger-menu" onclick="toggleMobileNav()" aria-label="Toggle navigation">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <div class="logo">ConstructConnect</div>
  <div class="user-menu">
    <span>Christopher Donaldson</span>
    <div class="avatar">CD</div>
  </div>
</div>

<!-- Mobile Navigation Overlay -->
<div class="mobile-nav-overlay" onclick="toggleMobileNav()"></div>

<!-- Mobile Navigation Drawer -->
<div class="mobile-nav-drawer">
  <div class="mobile-nav-item selected">
    <div class="mobile-nav-icon">üè¢</div>
    <div class="mobile-nav-label">Company</div>
  </div>
  <div class="mobile-nav-item">
    <div class="mobile-nav-icon">üë•</div>
    <div class="mobile-nav-label">Users</div>
  </div>
  <div class="mobile-nav-item">
    <div class="mobile-nav-icon">üìä</div>
    <div class="mobile-nav-label">Reports</div>
  </div>
  <div class="mobile-nav-item">
    <div class="mobile-nav-icon">‚öôÔ∏è</div>
    <div class="mobile-nav-label">Settings</div>
  </div>
  <div class="mobile-nav-item">
    <div class="mobile-nav-icon">üí≥</div>
    <div class="mobile-nav-label">Billing</div>
  </div>
  <div class="mobile-nav-item">
    <div class="mobile-nav-icon">üîî</div>
    <div class="mobile-nav-label">Notifications</div>
  </div>
  <div class="mobile-nav-item">
    <div class="mobile-nav-icon">‚ùì</div>
    <div class="mobile-nav-label">Help</div>
  </div>
  <div class="mobile-nav-item">
    <div class="mobile-nav-icon">üö™</div>
    <div class="mobile-nav-label">Logout</div>
  </div>
</div>

<!-- Layout -->
<div class="layout">
  
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="nav-item">
      <svg class="nav-icon" viewBox="0 0 384 512" fill="currentColor"><path d="M48 0C21.5 0 0 21.5 0 48V464c0 26.5 21.5 48 48 48h96V432c0-26.5 21.5-48 48-48s48 21.5 48 48v80h96c26.5 0 48-21.5 48-48V48c0-26.5-21.5-48-48-48H48zM64 240c0-8.8 7.2-16 16-16h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V240zm112-16h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H176c-8.8 0-16-7.2-16-16V240c0-8.8 7.2-16 16-16zm80 16c0-8.8 7.2-16 16-16h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V240zM80 96h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16zm80 16c0-8.8 7.2-16 16-16h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H176c-8.8 0-16-7.2-16-16V112zm112-16h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16z"/></svg>
      <div class="nav-label">Company</div>
    </div>
    <div class="nav-item">
      <svg class="nav-icon" viewBox="0 0 640 512" fill="currentColor"><path d="M144 0a80 80 0 1 1 0 160A80 80 0 1 1 144 0zM512 0a80 80 0 1 1 0 160A80 80 0 1 1 512 0zM0 298.7C0 239.8 47.8 192 106.7 192h42.7c15.9 0 31 3.5 44.6 9.7c-1.3 7.2-1.9 14.7-1.9 22.3c0 38.2 16.8 72.5 43.3 96c-.2 0-.4 0-.7 0H21.3C9.6 320 0 310.4 0 298.7zM405.3 320c-.2 0-.4 0-.7 0c26.6-23.5 43.3-57.8 43.3-96c0-7.6-.7-15-1.9-22.3c13.6-6.3 28.7-9.7 44.6-9.7h42.7C592.2 192 640 239.8 640 298.7c0 11.8-9.6 21.3-21.3 21.3H405.3zM224 224a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zM128 485.3C128 411.7 187.7 352 261.3 352H378.7C452.3 352 512 411.7 512 485.3c0 14.7-11.9 26.7-26.7 26.7H154.7c-14.7 0-26.7-11.9-26.7-26.7z"/></svg>
      <div class="nav-label">Users &<br>Groups</div>
    </div>
    <div class="nav-item">
      <svg class="nav-icon" viewBox="0 0 512 512" fill="currentColor"><path d="M256 0c4.6 0 9.2 1 13.4 2.9L457.7 82.8c22 9.3 38.4 31 38.3 57.2c-.5 99.2-41.3 280.7-213.6 363.2c-16.7 8-36.1 8-52.8 0C57.3 420.7 16.5 239.2 16 140c-.1-26.2 16.3-47.9 38.3-57.2L242.7 2.9C246.8 1 251.4 0 256 0zm0 66.8V444.8C394 378 431.1 230.1 432 141.4L256 66.8l0 0z"/></svg>
      <div class="nav-label">Roles</div>
    </div>
    <div class="nav-item selected">
      <svg class="nav-icon" viewBox="0 0 576 512" fill="currentColor"><path d="M512 80c8.8 0 16 7.2 16 16v32H48V96c0-8.8 7.2-16 16-16H512zm16 144V416c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V224H528zM64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H512c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zm56 304c-13.3 0-24 10.7-24 24s10.7 24 24 24h48c13.3 0 24-10.7 24-24s-10.7-24-24-24H120zm128 0c-13.3 0-24 10.7-24 24s10.7 24 24 24H360c13.3 0 24-10.7 24-24s-10.7-24-24-24H248z"/></svg>
      <div class="nav-label">Subs &<br>Licenses</div>
    </div>
    <div class="nav-item">
      <svg class="nav-icon" viewBox="0 0 384 512" fill="currentColor"><path d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM64 80c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s-7.2 16-16 16H80c-8.8 0-16-7.2-16-16zm0 64c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s-7.2 16-16 16H80c-8.8 0-16-7.2-16-16zm128 72c8.8 0 16 7.2 16 16v17.3c8.5 1.2 16.7 3.1 24.1 5.1c8.5 2.3 13.6 11 11.3 19.6s-11 13.6-19.6 11.3c-11.1-3-22-5.2-32.1-5.3c-8.4-.1-17.4 1.8-23.6 5.5c-5.7 3.4-8.1 7.3-8.1 12.8c0 3.7 1.3 6.5 7.3 10.1c6.9 4.1 16.6 7.1 29.2 10.9l.5 .1 0 0 0 0c11.3 3.4 25.3 7.6 36.3 14.6c12.1 7.6 22.4 19.7 22.7 38.2c.3 19.3-9.6 33.3-22.9 41.6c-7.7 4.8-16.4 7.6-25.1 9.1V440c0 8.8-7.2 16-16 16s-16-7.2-16-16V422.2c-11.2-2.1-21.7-5.7-30.9-8.9l0 0 0 0c-2.1-.7-4.2-1.4-6.2-2.1c-8.4-2.8-12.9-11.9-10.1-20.2s11.9-12.9 20.2-10.1c2.5 .8 4.8 1.6 7.1 2.4l0 0 0 0 0 0c13.6 4.6 24.6 8.4 36.3 8.7c9.1 .3 17.9-1.7 23.7-5.3c5.1-3.2 7.9-7.3 7.8-14c-.1-4.6-1.8-7.8-7.7-11.6c-6.8-4.3-16.5-7.4-29-11.2l-1.6-.5 0 0c-11-3.3-24.3-7.3-34.8-13.7c-12-7.2-22.6-18.9-22.7-37.3c-.1-19.4 10.8-32.8 23.8-40.5c7.5-4.4 15.8-7.2 24.1-8.7V232c0-8.8 7.2-16 16-16z"/></svg>
      <div class="nav-label">Billing</div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container">
      
      <!-- Header & Tabs -->
      <div class="header">
        <div class="header-top">
          <h1>Subscriptions and Licenses</h1>
          <div class="header-icons">
            <button class="header-icon primary" onclick="openInviteDrawer()" title="Invite User">üë§+</button>
            <button class="header-icon" title="Recent Activity">üïê</button>
            <button class="header-icon" title="User Profile">üë§</button>
          </div>
        </div>
        <div class="tabs">
          <button class="tab" onclick="window.location.href='v2-subscription-overview-multi.html'">Organization Overview</button>
          <button class="tab active">Project Intelligence</button>
          <button class="tab">Bid Management</button>
          <button class="tab">Takeoff and Estimating</button>
          <button class="tab" style="display: none;">API Apps</button>
        </div>
      </div>

      <!-- Split View -->
      <div class="split-view">
        
        <!-- LEFT PANEL: User Table -->
        <div class="left-panel">
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" placeholder="Search users...">
          </div>
          <table>
            <thead>
              <tr>
                <th style="width:40px">
                  <input type="checkbox" id="selectAllUsers" onclick="toggleAllUsers()">
                </th>
                <th>User Name</th>
                <th>Assigned Geography</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users"></tbody>
          </table>
        </div>

        <!-- RIGHT PANEL: Two-State Dynamic View -->
        <div class="right-panel">
          
          <!-- STATE 1: Default Info View (shows when no users selected) -->
          <div id="defaultView">
            <div class="content-wrapper">
              <!-- Pro Subscription Card -->
              <div class="subscription-card">
                <div class="subscription-title">Project Intelligence Pro Seats</div>
                <div class="subscription-subtitle">
                  Your current assigned seats for Project Intelligence Pro include:
                </div>
                <ul style="margin: 12px 0 12px 20px; font-size: 13px; line-height: 1.8; color: #666;">
                  <li>1 Full access</li>
                  <li>1 Modified</li>
                </ul>
                <div style="font-size: 13px; line-height: 1.6; color: #666; margin-bottom: 16px;">
                  <p style="margin-bottom: 8px;">By clicking 'add' you assign a seat and provide the user full access.</p>
                  <p>Once a user has been added, you can then modify their access to specific counties.</p>
                </div>
                <div class="seat-info">
                  7 / 20 Seats - 13 seats available
                  <div class="info-icon">
                    i
                    <div class="tooltip">Assigning geography to a user activates one seat.</div>
                  </div>
                </div>
                <div class="seat-bar"><div class="seat-fill" style="width: 35%"></div></div>
                
                <!-- Buttons inside card -->
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                  <button class="btn btn-secondary" id="addSelectedProBtn" disabled onclick="addSelectedUsers('Pro')">Add Selected User(s)</button>
                  <button class="btn btn-secondary" id="modifySelectedProBtn" disabled onclick="showModifyView('Pro')">Modify Selected Users</button>
                </div>
              </div>

              <!-- Starter Subscription Card -->
              <div class="subscription-card">
                <div class="subscription-title">Project Intelligence Starter Seats</div>
                <div class="subscription-subtitle">
                  Your current assigned seats for Project Intelligence Starter include:
                </div>
                <ul style="margin: 12px 0 12px 20px; font-size: 13px; line-height: 1.8; color: #666;">
                  <li>1 Full access</li>
                  <li>1 Modified</li>
                </ul>
                <div style="font-size: 13px; line-height: 1.6; color: #666; margin-bottom: 16px;">
                  <p style="margin-bottom: 8px;">By clicking 'add' you assign a seat and provide the user full access.</p>
                  <p>Once a user has been added, you can then modify their access to specific counties.</p>
                </div>
                <div class="seat-info">
                  7 / 20 Seats - 13 seats available
                  <div class="info-icon">
                    i
                    <div class="tooltip">Assigning geography to a user activates one seat.</div>
                  </div>
                </div>
                <div class="seat-bar"><div class="seat-fill" style="width: 35%"></div></div>
                
                <!-- Buttons inside card -->
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                  <button class="btn btn-secondary" id="addSelectedStarterBtn" disabled onclick="addSelectedUsers('Starter')">Add Selected User(s)</button>
                  <button class="btn btn-secondary" id="modifySelectedStarterBtn" disabled onclick="showModifyView('Starter')">Modify Selected Users</button>
                </div>
              </div>
            </div>
          </div>

          <!-- STATE 2: Zone Selection View (shows when users WITH subscriptions selected) -->
          <div id="zoneSelectionView">
            
            <!-- Subscription Card (stays at top) -->
            <div class="subscription-card" style="margin-bottom: 16px;">
              <div class="subscription-title">Project Intelligence Starter Seats</div>
              <div class="subscription-subtitle">
                Select zones and counties to assign to selected users.
              </div>
              <div class="seat-info">
                7 / 20 Seats - 13 seats available
              </div>
              <div class="seat-bar"><div class="seat-fill" style="width: 35%"></div></div>
            </div>

            <!-- Instruction Text -->
            <p style="margin-bottom: 16px; font-size: 14px; color: #666;">
              Select one or more of the zones below to assign to the selected user(s)
            </p>

            <!-- Zone Controls -->
            <div class="zone-controls" style="margin-bottom: 16px;">
              <label id="selectAllLabel" class="disabled-checkbox-label" style="font-weight:600;" data-disabled="false">
                <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                <span>Select All Zones</span>
              </label>
              <input type="text" placeholder="üîç Search zones..." style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 250px;">
            </div>

            <!-- Zone List (scrollable) -->
            <div class="zone-content" id="zones"></div>

            <!-- Save Button (Sticky Footer) -->
            <div class="actions">
              <button class="btn btn-secondary" onclick="reset()">Cancel</button>
              <button class="btn btn-primary" id="saveUpdatesBtn" onclick="save()" disabled>Save Updates</button>
            </div>

          </div>

        </div>

      </div>

    </div>
  </div>

</div>

<!-- Add User Drawer (Slide from Right) -->
<div id="addUserDrawer" class="drawer">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h2 style="margin: 0;">Invite User</h2>
    <button onclick="closeAddUserDrawer()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">‚úï</button>
  </div>
  
  <div style="text-align: center; padding: 48px 24px;">
    <div style="font-size: 64px; margin-bottom: 24px;">üìù</div>
    <h3 style="margin-bottom: 16px; color: #424242;">Invite User Workflow Coming Soon</h3>
    <p style="color: #999; font-size: 13px;">
      For now, use the "Modify" workflow to manage geographic access for existing subscription users.
    </p>
  </div>
  
  <div style="margin-top: 32px; text-align: center;">
    <button onclick="closeAddUserDrawer()" class="btn btn-primary">Close</button>
  </div>
</div>

<!-- Drawer Overlay -->
<div id="drawerOverlay" class="drawer-overlay" onclick="closeAddUserDrawer()"></div>

<!-- User Profile Drawer -->
<div id="userProfileDrawer" class="drawer">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h2 style="margin: 0;">User Profile Summary</h2>
    <button onclick="closeUserProfileDrawer()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">‚úï</button>
  </div>
  
  <div style="text-align: center; padding: 48px 24px;">
    <div style="font-size: 64px; margin-bottom: 24px;">üë§</div>
    <h3 id="userProfileName" style="margin-bottom: 16px; color: #424242;"></h3>
    <p style="color: #666; line-height: 1.6; margin-bottom: 24px;">
      User profile details coming soon
    </p>
    <p style="color: #999; font-size: 13px;">
      This will display comprehensive user information including role, permissions, subscription details, and activity history.
    </p>
  </div>
  
  <div style="margin-top: 32px; text-align: center;">
    <button onclick="closeUserProfileDrawer()" class="btn btn-primary">Close</button>
  </div>
</div>

<!-- User Profile Drawer Overlay -->
<div id="userProfileOverlay" class="drawer-overlay" onclick="closeUserProfileDrawer()"></div>

<!-- Success Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="success-icon">‚úì</div>
    <h2 style="margin-bottom: 16px;">Geography Updated!</h2>
    <p id="msg" style="color: #666; line-height: 1.6;"></p>
    <button onclick="closeModal()" class="btn btn-primary" style="margin-top: 24px;">Close</button>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal" id="confirmationModal">
  <div class="modal-content">
    <div class="success-icon">‚úì</div>
    <h2 style="margin-bottom: 12px;">User Added Successfully</h2>
    <p id="confirmationMessage" style="color: #666; line-height: 1.5; margin-bottom: 24px;"></p>
    <button onclick="closeConfirmationModal()" class="btn btn-primary">OK</button>
  </div>
</div>

<script src="complete-zone-data.js"></script>
<script>
// Initialize data
var data = {
  users: [
    {id:1, name:'Malcom Reynolds', role:'Chief Estimator', zones:'Full Access', zoneCount:null, accessType:'full', assignedCounties:{}, login:'Nov 5, 2025', subscription:'Pro', disabled:false},
    {id:2, name:'River Tam', role:'Chief Estimator', zones:'Modified', zoneCount:3, accessType:'modified', assignedCounties:{'1-1':true,'1-2':true,'2-1':true}, login:'Nov 5, 2025', subscription:'Starter', disabled:false},
    {id:3, name:'Zoe Washburne', role:'Estimator', zones:'Modified', zoneCount:2, accessType:'modified', assignedCounties:{'3-1':true,'4-1':true}, login:'Nov 5, 2025', subscription:'Pro', disabled:false},
    {id:4, name:'Kylee Frye', role:'Estimator', zones:'No Access', zoneCount:0, accessType:'none', assignedCounties:{}, login:'Nov 5, 2025', subscription:null, disabled:false},
    {id:5, name:'Simon Tam', role:'Estimator', zones:'No Access', zoneCount:0, accessType:'none', assignedCounties:{}, login:'Nov 5, 2025', subscription:null, disabled:false},
    {id:6, name:'Jayne Cobb', role:'Project Manager', zones:'No Access', zoneCount:0, accessType:'none', assignedCounties:{}, login:'Nov 5, 2025', subscription:null, disabled:false},
    {id:7, name:'Inara Serra', role:'Business Analyst', zones:'No Access', zoneCount:0, accessType:'none', assignedCounties:{}, login:'Nov 5, 2025', subscription:null, disabled:false},
    {id:8, name:'Brandon Haystack', role:'Senior Estimator', zones:'No Access', zoneCount:0, accessType:'none', assignedCounties:{}, login:'Nov 5, 2025', subscription:null, disabled:false}
  ],
  zones: COMPLETE_ZONE_DATA.zones.slice(0, 10) // First 10 zones for performance
};

// Selection state
var sel = {users:{}, counties:{}};
var expanded = {};
var showAll = {};

// Render function
function render() {
  // Render user table
  var h = '';
  for(var i = 0; i < data.users.length; i++) {
    var u = data.users[i];
    var rowClass = sel.users[u.id] ? 'selected' : '';
    
    h += '<tr class="' + rowClass + '">';
    
    // Checkbox
    h += '<td><input type="checkbox" ' + (sel.users[u.id] ? 'checked' : '') + 
         ' onclick="toggleUser(' + u.id + ')"></td>';
    
    // User name
    h += '<td><div><a onclick="openUserProfileDrawer(\'' + u.name + '\')" class="user-link">' + u.name + '</a></div>' +
         '<div class="user-role">' + u.role + '</div></td>';
    
    // Geography
    var zoneHtml = '';
    if(u.accessType === 'none') {
      zoneHtml = '<span class="zone-badge no-access">No Access</span>';
    } else if(u.accessType === 'full') {
      zoneHtml = '<span class="zone-badge">Full Access</span>';
      if(u.subscription === 'Pro') {
        zoneHtml += ' <span class="zone-badge">PRO</span>';
      }
    } else if(u.accessType === 'modified') {
      zoneHtml = '<span class="zone-badge">Modified</span>';
      if(u.subscription === 'Pro' && u.zoneCount) {
        zoneHtml += ' <span class="zone-badge">PRO - ' + u.zoneCount + '</span>';
      }
    } else {
      zoneHtml = '<span class="zone-badge">' + u.zones + '</span>';
    }
    h += '<td>' + zoneHtml + '</td>';
    
    // Actions
    h += '<td><div class="user-actions">';
    if(u.accessType === 'none') {
      h += '<button class="action-btn add" onclick="addUserFromTable(' + u.id + ')">+ Add</button>';
    } else {
      h += '<button class="action-btn remove" onclick="removeUser(' + u.id + ')">‚úï Remove</button>';
    }
    h += '</div></td>';
    
    h += '</tr>';
  }
  document.getElementById('users').innerHTML = h;
  
  // Render zones if zone view is active
  renderZones();
  
  // Update right panel view
  updateRightPanel();
  
  // Update header checkbox state
  updateUserHeaderState();
}

// Render zones
function renderZones() {
  var h = '';
  var indeterminateZones = []; // Track which zones need indeterminate state
  
  for(var i = 0; i < data.zones.length; i++) {
    var z = data.zones[i];
    var zoneState = getZoneCheckboxState(z.id);
    var isExpanded = expanded[z.id];
    var displayAll = showAll[z.id];
    
    h += '<div class="zone-card' + (isExpanded ? ' expanded' : '') + '">';
    h += '<div class="zone-header" onclick="toggleExpand(' + z.id + ')">';
    
    // Zone checkbox with data-zone-id for later indeterminate setting
    h += '<input type="checkbox" data-zone-id="' + z.id + '" ' +
         (zoneState.checked ? 'checked' : '') +
         ' onclick="event.stopPropagation(); toggleZone(' + z.id + ')">';
    
    // Track indeterminate zones
    if(zoneState.indeterminate) {
      indeterminateZones.push(z.id);
    }
    
    // Zone info
    h += '<div class="zone-info">';
    h += '<div class="zone-name">' + z.name + '</div>';
    h += '<div class="zone-details">' + z.states.join(', ') + ' - ' + z.countyCount + ' Counties Available</div>';
    h += '</div>';
    
    // User count badge
    h += '<div class="zone-users">üë• 5</div>';
    
    // Expand arrow
    h += '<div class="expand-arrow">‚ñº</div>';
    h += '</div>';
    
    // Counties (expandable)
    if(isExpanded) {
      h += '<div class="zone-counties">';
      h += '<div class="county-grid">';
      
      var countiesToShow = displayAll ? z.counties.length : Math.min(20, z.counties.length);
      for(var j = 0; j < countiesToShow; j++) {
        var county = z.counties[j];
        var countyKey = z.id + '-' + j;
        h += '<div class="county-item">';
        h += '<input type="checkbox" ' + (sel.counties[countyKey] ? 'checked' : '') +
             ' onclick="toggleCounty(' + z.id + ', ' + j + ')">';
        h += '<span>' + county.name + ' (' + county.state + ')</span>';
        h += '</div>';
      }
      
      h += '</div>';
      
      // Show all button if more than 20 counties
      if(z.counties.length > 20 && !displayAll) {
        h += '<div class="show-all" onclick="toggleShowAll(' + z.id + ')">Show all ' + z.counties.length + ' counties</div>';
      }
      
      h += '</div>';
    }
    
    h += '</div>';
  }
  
  document.getElementById('zones').innerHTML = h;
  
  // Set indeterminate state via JavaScript (can't be done in HTML)
  for(var i = 0; i < indeterminateZones.length; i++) {
    var checkbox = document.querySelector('input[data-zone-id="' + indeterminateZones[i] + '"]');
    if(checkbox) {
      checkbox.indeterminate = true;
    }
  }
  
  // Update "Select All Zones" checkbox state
  updateSelectAllZonesState();
}

// Update "Select All Zones" checkbox state
function updateSelectAllZonesState() {
  var selectAllCheckbox = document.getElementById('selectAll');
  if(!selectAllCheckbox) return;
  
  var totalCounties = 0;
  var selectedCounties = 0;
  
  for(var i = 0; i < data.zones.length; i++) {
    var zone = data.zones[i];
    totalCounties += zone.counties.length;
    for(var j = 0; j < zone.counties.length; j++) {
      if(sel.counties[zone.id + '-' + j]) {
        selectedCounties++;
      }
    }
  }
  
  if(selectedCounties === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  } else if(selectedCounties === totalCounties) {
    selectAllCheckbox.checked = true;
    selectAllCheckbox.indeterminate = false;
  } else {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = true;
  }
}

// Update right panel based on user selection
function updateRightPanel() {
  // Count selected users by type and subscription
  var selectedNoAccess = 0;
  var selectedFull = 0;
  var selectedModified = 0;
  var selectedPro = 0;
  var selectedStarter = 0;
  var selectedUsers = [];
  
  for(var i = 0; i < data.users.length; i++) {
    if(sel.users[data.users[i].id]) {
      selectedUsers.push(data.users[i]);
      if(data.users[i].accessType === 'none') {
        selectedNoAccess++;
      } else if(data.users[i].accessType === 'full') {
        selectedFull++;
      } else if(data.users[i].accessType === 'modified') {
        selectedModified++;
      }
      
      // Count by subscription
      if(data.users[i].subscription === 'Pro') {
        selectedPro++;
      } else if(data.users[i].subscription === 'Starter') {
        selectedStarter++;
      }
    }
  }
  
  // Update Pro subscription buttons
  var addProBtn = document.getElementById('addSelectedProBtn');
  var modifyProBtn = document.getElementById('modifySelectedProBtn');
  
  if(addProBtn) {
    // Enable if selecting no-access users AND no Starter users are selected
    addProBtn.disabled = !(selectedNoAccess > 0 && selectedStarter === 0);
  }
  if(modifyProBtn) {
    // Enable if selecting Pro users only
    modifyProBtn.disabled = !(selectedPro > 0 && selectedStarter === 0 && selectedNoAccess === 0);
  }
  
  // Update Starter subscription buttons
  var addStarterBtn = document.getElementById('addSelectedStarterBtn');
  var modifyStarterBtn = document.getElementById('modifySelectedStarterBtn');
  
  if(addStarterBtn) {
    // Enable if selecting no-access users AND no Pro users are selected
    addStarterBtn.disabled = !(selectedNoAccess > 0 && selectedPro === 0);
  }
  if(modifyStarterBtn) {
    // Enable if selecting Starter users only
    modifyStarterBtn.disabled = !(selectedStarter > 0 && selectedPro === 0 && selectedNoAccess === 0);
  }
  
  // Check if any users are selected - if not, switch back to default view
  if(selectedUsers.length === 0) {
    var defaultView = document.getElementById('defaultView');
    var zoneView = document.getElementById('zoneSelectionView');
    defaultView.style.display = 'flex';
    zoneView.style.display = 'none';
    zoneView.classList.remove('active');
  }
}

// Toggle user selection
function toggleUser(id) {
  sel.users[id] = !sel.users[id];
  render();
}

// Toggle all users
function toggleAllUsers() {
  var checkbox = document.getElementById('selectAllUsers');
  var newState = checkbox.checked;
  
  for(var i = 0; i < data.users.length; i++) {
    sel.users[data.users[i].id] = newState;
  }
  render();
}

// Update header checkbox state
function updateUserHeaderState() {
  var selectedCount = 0;
  
  for(var i = 0; i < data.users.length; i++) {
    if(sel.users[data.users[i].id]) selectedCount++;
  }
  
  var checkbox = document.getElementById('selectAllUsers');
  checkbox.checked = selectedCount === data.users.length && data.users.length > 0;
  checkbox.indeterminate = selectedCount > 0 && selectedCount < data.users.length;
}

// Zone checkbox state
function getZoneCheckboxState(zoneId){
  var zone = data.zones.find(z => z.id === zoneId);
  if(!zone) return {checked: false, indeterminate: false};
  var selectedCount = 0;
  for(var i = 0; i < zone.counties.length; i++){
    if(sel.counties[zoneId + '-' + i]) selectedCount++;
  }
  if(selectedCount === 0) return {checked: false, indeterminate: false};
  if(selectedCount === zone.counties.length) return {checked: true, indeterminate: false};
  return {checked: false, indeterminate: true};
}

// Toggle zone
function toggleZone(id){
  var zone = data.zones.find(z => z.id === id);
  if(!zone) return;
  var state = getZoneCheckboxState(id);
  var newState = !state.checked && !state.indeterminate;
  for(var i = 0; i < zone.counties.length; i++){
    sel.counties[id + '-' + i] = newState;
  }
  updateSaveButton();
  render();
}

// Toggle county
function toggleCounty(zoneId, countyIndex){
  var countyKey = zoneId + '-' + countyIndex;
  sel.counties[countyKey] = !sel.counties[countyKey];
  updateSaveButton();
  render();
}

// Update Save Updates button state
function updateSaveButton() {
  var saveBtn = document.getElementById('saveUpdatesBtn');
  if(!saveBtn) return;
  
  // Check if any counties are selected
  var hasSelection = false;
  for(var key in sel.counties) {
    if(sel.counties[key]) {
      hasSelection = true;
      break;
    }
  }
  
  saveBtn.disabled = !hasSelection;
}

// Toggle expand
function toggleExpand(id){
  expanded[id] = !expanded[id];
  render();
}

// Toggle show all counties
function toggleShowAll(id){
  showAll[id] = !showAll[id];
  render();
}

// Toggle select all zones
function toggleSelectAll(){
  var checkbox = document.getElementById('selectAll');
  var newState = checkbox.checked;
  
  for(var i = 0; i < data.zones.length; i++){
    var zone = data.zones[i];
    for(var j = 0; j < zone.counties.length; j++){
      sel.counties[zone.id + '-' + j] = newState;
    }
  }
  updateSaveButton();
  render();
}

// Add selected users (assign subscriptions)
function addSelectedUsers() {
  var selectedUsers = [];
  for(var i = 0; i < data.users.length; i++) {
    if(sel.users[data.users[i].id] && data.users[i].accessType === 'none') {
      selectedUsers.push(data.users[i].name);
      // Update user to Full Access
      data.users[i].zones = 'Full Access';
      data.users[i].accessType = 'full';
      data.users[i].zoneCount = null;
      data.users[i].assignedCounties = {};
    }
  }
  
  if(selectedUsers.length > 0) {
    alert('Added subscription and Full Access for: ' + selectedUsers.join(', '));
    // Clear selections and re-render
    sel.users = {};
    sel.counties = {};
    render();
  }
}

// Show modify view (switch to zone selection)
function showModifyView() {
  // Clear current county selections
  sel.counties = {};
  
  // Pre-populate with counties from selected modified users
  // If multiple users selected, merge their counties
  for(var i = 0; i < data.users.length; i++) {
    var u = data.users[i];
    if(sel.users[u.id] && u.accessType === 'modified' && u.assignedCounties) {
      for(var key in u.assignedCounties) {
        if(u.assignedCounties[key]) {
          sel.counties[key] = true;
        }
      }
    }
  }
  
  // Show zone selection view
  var defaultView = document.getElementById('defaultView');
  var zoneView = document.getElementById('zoneSelectionView');
  
  defaultView.style.display = 'none';
  zoneView.style.display = 'flex';
  zoneView.classList.add('active');
  
  // Render zones with pre-populated selections
  renderZones();
  updateSaveButton();
}

// Open invite drawer (for adding NEW users to organization)
function openInviteDrawer() {
  document.getElementById('addUserDrawer').classList.add('show');
  document.getElementById('drawerOverlay').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeAddUserDrawer() {
  document.getElementById('addUserDrawer').classList.remove('show');
  document.getElementById('drawerOverlay').classList.remove('show');
  document.body.style.overflow = 'auto';
}

// Add user from table (assign seat to existing No Access user)
function addUserFromTable(userId) {
  // Find the user
  var user = data.users.find(function(u) { return u.id === userId; });
  if (!user) return;
  
  // Assign full access - update ALL properties
  user.zones = 'Full Access';
  user.accessType = 'full';
  user.zoneCount = null;
  user.assignedCounties = {};
  
  // Unselect the user
  delete sel.users[userId];
  
  // Re-render and update panel
  render();
  
  // Show confirmation modal
  var modal = document.getElementById('confirmationModal');
  var message = document.getElementById('confirmationMessage');
  message.textContent = user.name + ' has been assigned a full seat to this subscription.';
  modal.classList.add('show');
}

function closeConfirmationModal() {
  document.getElementById('confirmationModal').classList.remove('show');
}

// Remove user
function removeUser(userId) {
  if(confirm('Remove this user\'s subscription and geographic access?')) {
    var user = data.users.find(u => u.id === userId);
    if(user) {
      user.zones = 'No Access';
      user.disabled = true;
      sel.users[userId] = false;
      render();
    }
  }
}

// Save
function save(){
  var un = [], selections = [];
  
  // Get selected user names
  for(var i=0; i<data.users.length; i++) {
    if(sel.users[data.users[i].id]) un.push(data.users[i].name);
  }
  
  // Get selected geography summary
  for(var i=0; i<data.zones.length; i++){
    var z = data.zones[i];
    var selectedCounties = [];
    for(var j=0; j<z.counties.length; j++){
      if(sel.counties[z.id+'-'+j]) selectedCounties.push(z.counties[j]);
    }
    if(selectedCounties.length > 0){
      if(selectedCounties.length === z.counties.length){
        selections.push(z.name + ' (All ' + z.counties.length + ' counties)');
      } else {
        selections.push(z.name + ' (' + selectedCounties.length + ' of ' + z.counties.length + ' counties)');
      }
    }
  }
  
  // Show modal
  document.getElementById('msg').innerHTML = 
    'Geography assigned to: ' + un.join(', ') + '<br><br>Selections: ' + selections.join(', ');
  document.getElementById('modal').className = 'modal show';
  
  // Update user data
  for(var i=0; i<data.users.length; i++){
    if(sel.users[data.users[i].id]){
      data.users[i].zones = 'Modified ' + selections.length;
    }
  }
}

// Close modal
function closeModal(){
  document.getElementById('modal').className = 'modal';
  reset();
}

// Reset
function reset(){
  sel = {users:{}, counties:{}};
  expanded = {};
  showAll = {};
  
  // Return to default view
  var defaultView = document.getElementById('defaultView');
  var zoneView = document.getElementById('zoneSelectionView');
  defaultView.style.display = 'flex';
  zoneView.style.display = 'none';
  zoneView.classList.remove('active');
  
  render();
}

// Open user profile drawer
function openUserProfileDrawer(userName) {
  document.getElementById('userProfileName').textContent = userName;
  document.getElementById('userProfileDrawer').classList.add('show');
  document.getElementById('userProfileOverlay').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeUserProfileDrawer() {
  document.getElementById('userProfileDrawer').classList.remove('show');
  document.getElementById('userProfileOverlay').classList.remove('show');
  document.body.style.overflow = 'auto';
}

// Initialize
render();
</script>

<script>
function toggleMobileNav() {
  const drawer = document.querySelector('.mobile-nav-drawer');
  const overlay = document.querySelector('.mobile-nav-overlay');
  const hamburger = document.querySelector('.hamburger-menu');
  
  drawer.classList.toggle('show');
  overlay.classList.toggle('show');
  hamburger.classList.toggle('active');
}
</script>

</body>
</html>
